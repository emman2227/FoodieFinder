<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu</title>
    <link rel="stylesheet" href="assets/menu.css">
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <img src="logo.png" alt="Logo" class="sidebar-logo">
            <button class="menu-button" onclick="window.location.href='dashboard.html';">Dashboard</button>
            <button class="menu-button active" onclick="window.location.href='menu.html';">Menu</button>
            <button class="menu-button" onclick="window.location.href='order.html';">Orders</button>
            <button class="menu-button" onclick="window.location.href='bingo.html';">Bingo Card</button>
            <button class="menu-button" onclick="window.location.href='settings.html';">Settings</button>
        </div>

        <div class="main-content">
            <header class="header">
                <h1>Menu</h1>
            </header>

            <div class="testimonial-box-wrapper">
                <div class="testimonial-box-container">
                    <h1>Menu Management</h1>
                    <div class="button-container">
                        <button class="add" onclick="window.location.href='menu2.html'">Add Menu +</button>
                    </div>

                    <div id="menuContainer" class="menu-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
async function loadMenu() {
    const menuContainer = document.getElementById('menuContainer');
    menuContainer.innerHTML = '';

    const shopId = 2;

    try {
        const response = await fetch(`https://mature-pig-apparently.ngrok-free.app/FoodieFinder/api/index.php?route=shop-get-menu&shop_id=${shopId}`);

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const text = await response.text();  
        console.log("Raw API Response:", text);

        if (text.startsWith("<!DOCTYPE html>")) {
        console.error("Server returned an HTML page instead of JSON.");
        menuContainer.innerHTML = "<p>Server error: Unable to load menu.</p>";
        return;
    }

        let menus;
        try {
            menus = JSON.parse(text); // Convert JSON string into an object
            console.log("Parsed JSON Data:", menus); 
        } catch (jsonError) {
            console.error("JSON Parse Error:", jsonError);
            menuContainer.innerHTML = '<p>Invalid JSON response from server.</p>';
            return;
        }

        // Ensure data is in the expected format
        if (!menus || typeof menus !== "object" || !Array.isArray(menus.data) || menus.data.length === 0) {
            menuContainer.innerHTML = '<p>No menu items available.</p>';
            return;
        }

        // Loop through and render menu items
        menus.data.forEach(menu => {
            const menuItem = document.createElement('div');
            menuItem.classList.add('testimonial-box');

            menuItem.innerHTML = `
                <div class="box-top">
                    <div class="name-user">
                        <strong>${menu.product_name}</strong><br/>
                        <span>${menu.price}</span>
                    </div>
                </div>
                <div class="orange-box">
                    <img src="${menu.image}" alt="${menu.product_name}" style="width: 100%; height: auto; border-radius: 5px;">
                </div>
                <p>${menu.description}</p>
                <div class="button-container">
                    <button class="delete-btn" onclick="deleteMenu(${menu.id})">Delete</button>
                </div>
            `;

            menuContainer.appendChild(menuItem);
        });

    } catch (error) {
        console.error("Error fetching menu:", error);
        menuContainer.innerHTML = '<p>Error loading menu items.</p>';
    }
}

async function deleteMenu(id) {
try {
    const response = await fetch('https://mature-pig-apparently.ngrok-free.app/FoodieFinder/api/index.php?route=delete-product', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id })
    });

    const result = await response.json();
    console.log("Delete Response:", result);

    if (result.status === 200) {  // Ensure correct API response handling
        alert("Menu item deleted successfully!");
        loadMenu(); // Refresh menu after deletion
    } else {
        alert("Failed to delete menu item.");
    }
} catch (error) {
    console.error("Error deleting menu item:", error);
    alert("An error occurred while deleting the menu item.");
}
}

document.addEventListener("DOMContentLoaded", loadMenu);
    </script>
</body>
</html>
